# Protected Routes & Auth Flow

## üì° What you will learn

- Understand how protected routes work with Expo Router.
- Add an authentication flow using route groups.
- Redirect unauthenticated users automatically.
- Use React Context to manage auth state across the app.

## üëæ Before we start the exercise

- Check the [Authentication documentation](https://docs.expo.dev/router/reference/authentication/).
- Check the [Route groups documentation](https://docs.expo.dev/router/layouts/#groups).
- Check the [Redirect documentation](https://docs.expo.dev/router/reference/redirects/).

Here is a preview of our application user flow:

![expo-router](https://raw.githubusercontent.com/flexbox/react-native-workshop/main/challenges/react-navigation/react-navigation.png)

## üë®‚ÄçüöÄ Exercise 3

### Understanding Protected Routes

Protected routes are routes that require authentication to access. In Expo Router, we protect routes by:

1. **Grouping routes** with `(parentheses)` folders
2. **Checking auth state** in the layout component
3. **Redirecting** unauthenticated users to the login screen

### Organize routes with groups

- [ ] Reorganize your `app/` folder to separate auth and protected routes for the Spacecraft app:

```
app/
  _layout.tsx              ‚Üí Root layout with providers
  (auth)/
    _layout.tsx            ‚Üí Auth stack layout
    index.tsx              ‚Üí LoginScreen (/)
    terms.tsx              ‚Üí TermsScreen (/terms)
  (app)/
    _layout.tsx            ‚Üí Protected layout with auth check
    (tabs)/
      _layout.tsx          ‚Üí Bottom Tab Navigator
      starships/
        index.tsx          ‚Üí StarshipFeedScreen
        [id].tsx           ‚Üí StarshipDetailsScreen
      pilots/
        index.tsx          ‚Üí PilotScreen
        [id].tsx           ‚Üí PilotDetailsScreen
      planets/
        index.tsx          ‚Üí PlanetsScreen
        [id].tsx           ‚Üí PlanetDetailsScreen
      plus/
        index.tsx          ‚Üí PlusScreen
        feedback.tsx       ‚Üí DoYouLikeScreen
```

**üî≠ Hint:** Route groups (folders with parentheses) don't affect the URL. `(auth)/index.tsx` maps to `/`, not `/(auth)/`.

### Create an Auth Context

- [ ] Create `src/context/AuthContext.tsx` to manage authentication state:

```javascript
// src/context/AuthContext.tsx
import { createContext, useContext, useState, ReactNode } from "react";

type AuthContextType = {
  user: boolean;
  signIn: () => void;
  signOut: () => void;
};

const AuthContext = createContext<AuthContextType | null>(null);

export function AuthProvider({ children }: { children: ReactNode }) {
  const [user, setUser] = useState(false);

  const signIn = () => setUser(true);
  const signOut = () => setUser(false);

  return (
    <AuthContext.Provider value={{ user, signIn, signOut }}>
      {children}
    </AuthContext.Provider>
  );
}

export function useAuth() {
  const context = useContext(AuthContext);
  if (!context) {
    throw new Error("useAuth must be used within an AuthProvider");
  }
  return context;
}
```

### Setup the root layout with providers

- [ ] Update `app/_layout.tsx` to wrap your app with all providers (Auth, React Query, Paper):

```javascript
// app/_layout.tsx
import { Slot } from "expo-router";
import { QueryClient, QueryClientProvider } from "@tanstack/react-query";
import { PaperProvider } from "react-native-paper";
import { AuthProvider } from "../src/context/AuthContext";
import { theme } from "../src/theme/theme";

const queryClient = new QueryClient();

export default function RootLayout() {
  return (
    <QueryClientProvider client={queryClient}>
      <PaperProvider theme={theme}>
        <AuthProvider>
          <Slot />
        </AuthProvider>
      </PaperProvider>
    </QueryClientProvider>
  );
}
```

### Create the protected route layout

This is the key part: the `(app)/_layout.tsx` file checks if the user is authenticated and redirects to the login page if not.

- [ ] Create `app/(app)/_layout.tsx` to protect all routes inside:

```javascript
// app/(app)/_layout.tsx
import { Redirect, Stack } from "expo-router";
import { useAuth } from "../../src/context/AuthContext";

export default function AppLayout() {
  const { user } = useAuth();

  // üîê PROTECTED ROUTE CHECK
  // If not authenticated, redirect to login
  if (!user) {
    return <Redirect href="/" />;
  }

  // User is authenticated, render the app
  return <Stack screenOptions={{ headerShown: false }} />;
}
```

**üîê How it works:**

1. When a user tries to access any route inside `(app)/`, this layout runs first
2. It checks if `user` is truthy (authenticated)
3. If not authenticated ‚Üí `<Redirect href="/" />` sends them to login
4. If authenticated ‚Üí renders the `<Stack />` with child routes

### Create the auth layout

- [ ] Create `app/(auth)/_layout.tsx` for the authentication screens:

```javascript
// app/(auth)/_layout.tsx
import { Redirect, Stack } from "expo-router";
import { useAuth } from "../../src/context/AuthContext";

export default function AuthLayout() {
  const { user } = useAuth();

  // If already authenticated, redirect to the app
  if (user) {
    return <Redirect href="/starships" />;
  }

  return (
    <Stack screenOptions={{ headerShown: false }}>
      <Stack.Screen name="index" />
      <Stack.Screen name="terms" />
    </Stack>
  );
}
```

### Add sign in / sign out functionality

- [ ] Update the LoginScreen to sign in:

```javascript
// app/(auth)/index.tsx
import { useRouter } from "expo-router";
import { useAuth } from "../../src/context/AuthContext";

export default function LoginScreen() {
  const { signIn } = useAuth();
  const router = useRouter();

  const handleSignIn = () => {
    signIn();
    // Use replace to prevent going back to login
    router.replace("/starships");
  };

  return (
    <View>
      {/* Your login form here */}
      <Button title="Sign in" onPress={handleSignIn} />
    </View>
  );
}
```

- [ ] Add a sign out button in the PlusScreen:

```javascript
// app/(app)/(tabs)/plus/index.tsx
import { useRouter } from "expo-router";
import { useAuth } from "../../../../src/context/AuthContext";

export default function PlusScreen() {
  const { signOut } = useAuth();
  const router = useRouter();

  const handleSignOut = () => {
    signOut();
    router.replace("/");
  };

  return (
    <View>
      <Button title="Sign out" onPress={handleSignOut} />
    </View>
  );
}
```

**üî≠ Hint:** Use `router.replace()` instead of `router.push()` to prevent the user from going back to the previous screen with the back button.

## üëΩ Bonus

### Add the Bottom Tab Navigator

- [ ] Create `app/(app)/(tabs)/_layout.tsx` for the Spacecraft tabs:

```javascript
// app/(app)/(tabs)/_layout.tsx
import { Tabs } from "expo-router";
import { useTheme } from "react-native-paper";
import { Ionicons } from "@expo/vector-icons";

export default function TabLayout() {
  const theme = useTheme();

  return (
    <Tabs
      screenOptions={{
        headerShown: false,
        tabBarActiveTintColor: theme.colors.primary,
      }}
    >
      <Tabs.Screen
        name="starships"
        options={{
          title: "Starships",
          tabBarIcon: ({ color }) => (
            <Ionicons name="rocket" size={24} color={color} />
          ),
        }}
      />
      <Tabs.Screen
        name="pilots"
        options={{
          title: "Pilots",
          tabBarIcon: ({ color }) => (
            <Ionicons name="people" size={24} color={color} />
          ),
        }}
      />
      <Tabs.Screen
        name="planets"
        options={{
          title: "Planets",
          tabBarIcon: ({ color }) => (
            <Ionicons name="planet" size={24} color={color} />
          ),
        }}
      />
      <Tabs.Screen
        name="plus"
        options={{
          title: "Plus",
          tabBarIcon: ({ color }) => (
            <Ionicons name="add-circle" size={24} color={color} />
          ),
        }}
      />
    </Tabs>
  );
}
```

### Nested stack for each tab

- [ ] Create a nested layout for the starships tab with details modal:

```javascript
// app/(app)/(tabs)/starships/_layout.tsx
import { Stack } from "expo-router";

export default function StarshipsLayout() {
  return (
    <Stack>
      <Stack.Screen
        name="index"
        options={{ title: "Starships" }}
      />
      <Stack.Screen
        name="[id]"
        options={{
          presentation: "modal",
          title: "Starship Details",
        }}
      />
    </Stack>
  );
}
```

### Persist authentication with expo-secure-store

- [ ] Install `expo-secure-store` and persist the user token:

```bash
npx expo install expo-secure-store
```

```javascript
// src/context/AuthContext.tsx
import * as SecureStore from "expo-secure-store";
import { useEffect } from "react";

export function AuthProvider({ children }: { children: ReactNode }) {
  const [user, setUser] = useState<boolean | null>(null); // null = loading

  const signIn = async () => {
    await SecureStore.setItemAsync("userToken", "authenticated");
    setUser(true);
  };

  const signOut = async () => {
    await SecureStore.deleteItemAsync("userToken");
    setUser(false);
  };

  // Check for existing token on app load
  useEffect(() => {
    const checkToken = async () => {
      const token = await SecureStore.getItemAsync("userToken");
      setUser(!!token);
    };
    checkToken();
  }, []);

  // Don't render until we know the auth state
  if (user === null) {
    return null; // Or a loading spinner
  }

  return (
    <AuthContext.Provider value={{ user, signIn, signOut }}>
      {children}
    </AuthContext.Provider>
  );
}
```

### Add a splash screen during auth check

- [ ] Show a splash screen while checking authentication:

```javascript
// app/_layout.tsx
import { Slot, SplashScreen } from "expo-router";
import { useEffect, useState } from "react";
import * as SecureStore from "expo-secure-store";

// Prevent the splash screen from auto-hiding
SplashScreen.preventAutoHideAsync();

export default function RootLayout() {
  const [isReady, setIsReady] = useState(false);

  useEffect(() => {
    async function prepare() {
      try {
        // Check auth state, load fonts, fetch initial data...
        await SecureStore.getItemAsync("userToken");
      } finally {
        setIsReady(true);
        SplashScreen.hideAsync();
      }
    }
    prepare();
  }, []);

  if (!isReady) {
    return null;
  }

  return (
    <QueryClientProvider client={queryClient}>
      <PaperProvider theme={theme}>
        <AuthProvider>
          <Slot />
        </AuthProvider>
      </PaperProvider>
    </QueryClientProvider>
  );
}
```

### Test the protected routes

- [ ] Verify these scenarios work correctly:

1. **Unauthenticated user** visits `/starships` ‚Üí redirected to `/`
2. **Unauthenticated user** visits `/pilots` ‚Üí redirected to `/`
3. **Authenticated user** visits `/` ‚Üí redirected to `/starships`
4. **Authenticated user** signs out ‚Üí redirected to `/`
5. **Refresh the app** ‚Üí stays logged in (with persist)
