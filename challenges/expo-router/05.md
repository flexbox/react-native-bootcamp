# Auth Persistence & Splash Screen

## ðŸ“¡ What you will learn

- Persist authentication state with `expo-secure-store`.
- Handle splash screen during auth state loading.
- Test protected routes end-to-end.

## ðŸ‘¾ Before we start the exercise

- Make sure you have completed [Exercise 4](./04.md) with the Tab Navigator.
- Check the [Splash Screen documentation](https://docs.expo.dev/router/reference/splash-screen/).
- Check the [expo-secure-store documentation](https://docs.expo.dev/versions/latest/sdk/securestore/).

## ðŸ‘¨â€ðŸš€ Exercise 5

### Persist authentication with expo-secure-store

Right now, when you refresh the app, the user is logged out. Let's persist the authentication state using `expo-secure-store`.

- [ ] Install `expo-secure-store`:

```bash
npx expo install expo-secure-store
```

- [ ] Update `src/context/AuthContext.tsx` to persist the user token:

```javascript
// src/context/AuthContext.tsx
import { createContext, useContext, useState, ReactNode, useEffect } from "react";
import * as SecureStore from "expo-secure-store";

type AuthContextType = {
  user: boolean;
  isLoading: boolean;
  signIn: () => Promise<void>;
  signOut: () => Promise<void>;
};

const AuthContext = createContext<AuthContextType | null>(null);

export function AuthProvider({ children }: { children: ReactNode }) {
  const [user, setUser] = useState<boolean>(false);
  const [isLoading, setIsLoading] = useState(true);

  const signIn = async () => {
    await SecureStore.setItemAsync("userToken", "authenticated");
    setUser(true);
  };

  const signOut = async () => {
    await SecureStore.deleteItemAsync("userToken");
    setUser(false);
  };

  // Check for existing token on app load
  useEffect(() => {
    const checkToken = async () => {
      const token = await SecureStore.getItemAsync("userToken");
      setUser(!!token);
      setIsLoading(false);
    };
    checkToken();
  }, []);

  return (
    <AuthContext.Provider value={{ user, isLoading, signIn, signOut }}>
      {children}
    </AuthContext.Provider>
  );
}

export function useAuth() {
  const context = useContext(AuthContext);
  if (!context) {
    throw new Error("useAuth must be used within an AuthProvider");
  }
  return context;
}
```

### Add a splash screen during auth check

While the app is checking the authentication state, we want to show a splash screen instead of a blank screen or flickering.

- [ ] Update `app/_layout.tsx` to handle the splash screen:

```javascript
// app/_layout.tsx
import { Slot, SplashScreen } from "expo-router";
import { useEffect } from "react";
import { QueryClient, QueryClientProvider } from "@tanstack/react-query";
import { PaperProvider } from "react-native-paper";
import { AuthProvider, useAuth } from "../src/context/AuthContext";
import { theme } from "../src/theme/theme";

const queryClient = new QueryClient();

// Prevent the splash screen from auto-hiding
SplashScreen.preventAutoHideAsync();

function RootLayoutNav() {
  const { isLoading } = useAuth();

  useEffect(() => {
    if (!isLoading) {
      SplashScreen.hideAsync();
    }
  }, [isLoading]);

  if (isLoading) {
    return null;
  }

  return <Slot />;
}

export default function RootLayout() {
  return (
    <QueryClientProvider client={queryClient}>
      <PaperProvider theme={theme}>
        <AuthProvider>
          <RootLayoutNav />
        </AuthProvider>
      </PaperProvider>
    </QueryClientProvider>
  );
}
```

**ðŸ”­ Hint:** We need a separate `RootLayoutNav` component inside the `AuthProvider` to access the `useAuth` hook.

### Test the protected routes

- [ ] Verify these scenarios work correctly:

1. **Unauthenticated user** visits `/starships` â†’ redirected to `/`
2. **Unauthenticated user** visits `/pilots` â†’ redirected to `/`
3. **Authenticated user** visits `/` â†’ redirected to `/starships`
4. **Authenticated user** signs out â†’ redirected to `/`
5. **Refresh the app** â†’ stays logged in (with persist)

## ðŸ‘½ Bonus

- [ ] Add biometric authentication (Face ID / Touch ID) using `expo-local-authentication`.
- [ ] Store the user's email in SecureStore and pre-fill the login form on next visit.
