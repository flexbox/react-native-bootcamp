{"version":3,"sources":["../../../src/tools/config/index.ts"],"names":["getDependencyConfig","root","dependencyName","finalConfig","config","userConfig","isPlatform","name","platforms","Object","keys","reduce","dependency","platform","platformConfig","dependencyConfig","assets","hooks","params","dependencies","loadConfig","projectRoot","lazyProject","initialConfig","reactNativePath","path","resolve","commands","healthChecks","project","projectConfig","Array","from","Set","acc","localDependencyRoot","error","logger","warn","chalk","bold","dim","message","length"],"mappings":";;;;;;;AAAA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AAQA;AAAA;;AAAA;AAAA;AAAA;;AAAA;AAAA;;AACA;;AACA;;AACA;;AACA;;AACA;;AAIA;;AACA;;AACA;;;;AAEA,SAASA,mBAAT,CACEC,IADF,EAEEC,cAFF,EAGEC,WAHF,EAIEC,MAJF,EAKEC,UALF,EAMEC,UANF,EAOc;AACZ,SAAO,oBACL;AACEL,IAAAA,IADF;AAEEM,IAAAA,IAAI,EAAEL,cAFR;AAGEM,IAAAA,SAAS,EAAEC,MAAM,CAACC,IAAP,CAAYP,WAAW,CAACK,SAAxB,EAAmCG,MAAnC,CACT,CAACC,UAAD,EAAaC,QAAb,KAA0B;AACxB,YAAMC,cAAc,GAAGX,WAAW,CAACK,SAAZ,CAAsBK,QAAtB,CAAvB;AACAD,MAAAA,UAAU,CAACC,QAAD,CAAV,GACE;AACAP,MAAAA,UAAU,IAAI,CAACQ,cAAf,GACI,IADJ,GAEIA,cAAc,CAACC,gBAAf,CACEd,IADF,EAEEG,MAAM,CAACQ,UAAP,CAAkBJ,SAAlB,CAA4BK,QAA5B,CAFF,CAJN;AAQA,aAAOD,UAAP;AACD,KAZQ,EAaT,EAbS,CAHb;AAkBEI,IAAAA,MAAM,EAAE,yBAAWf,IAAX,EAAiBG,MAAM,CAACQ,UAAP,CAAkBI,MAAnC,CAlBV;AAmBEC,IAAAA,KAAK,EAAEb,MAAM,CAACQ,UAAP,CAAkBK,KAnB3B;AAoBEC,IAAAA,MAAM,EAAEd,MAAM,CAACQ,UAAP,CAAkBM;AApB5B,GADK,EAuBLb,UAAU,CAACc,YAAX,CAAwBjB,cAAxB,KAA2C,EAvBtC,CAAP;AAyBD;AAED;;;;;AAGA,SAASkB,UAAT,CAAoBC,WAAmB,GAAG,+BAA1C,EAAqE;AACnE,MAAIC,WAAJ;AACA,QAAMjB,UAAU,GAAG,4CAAmBgB,WAAnB,CAAnB;AAEA,QAAME,aAAqB,GAAG;AAC5BtB,IAAAA,IAAI,EAAEoB,WADsB;;AAE5B,QAAIG,eAAJ,GAAsB;AACpB,aAAOnB,UAAU,CAACmB,eAAX,GACHC,gBAAKC,OAAL,CAAaL,WAAb,EAA0BhB,UAAU,CAACmB,eAArC,CADG,GAEH,qCAAuBH,WAAvB,CAFJ;AAGD,KAN2B;;AAO5BF,IAAAA,YAAY,EAAEd,UAAU,CAACc,YAPG;AAQ5BQ,IAAAA,QAAQ,EAAEtB,UAAU,CAACsB,QARO;;AAS5B,QAAIX,MAAJ,GAAa;AACX,aAAO,yBAAWK,WAAX,EAAwBhB,UAAU,CAACW,MAAnC,CAAP;AACD,KAX2B;;AAY5BY,IAAAA,YAAY,EAAE,EAZc;AAa5BpB,IAAAA,SAAS,EAAEH,UAAU,CAACG,SAbM;;AAc5B,QAAIqB,OAAJ,GAAc;AACZ,UAAIP,WAAJ,EAAiB;AACf,eAAOA,WAAP;AACD;;AAEDA,MAAAA,WAAW,GAAG,EAAd;;AACA,WAAK,MAAMT,QAAX,IAAuBV,WAAW,CAACK,SAAnC,EAA8C;AAC5C,cAAMM,cAAc,GAAGX,WAAW,CAACK,SAAZ,CAAsBK,QAAtB,CAAvB;;AACA,YAAIC,cAAJ,EAAoB;AAClBQ,UAAAA,WAAW,CAACT,QAAD,CAAX,GAAwBC,cAAc,CAACgB,aAAf,CACtBT,WADsB,EAEtBhB,UAAU,CAACwB,OAAX,CAAmBhB,QAAnB,KAAgC,EAFV,CAAxB;AAID;AACF;;AAED,aAAOS,WAAP;AACD;;AA/B2B,GAA9B;AAkCA,QAAMnB,WAAW,GAAG4B,KAAK,CAACC,IAAN,CAClB,IAAIC,GAAJ,CAAQ,CACN,GAAGxB,MAAM,CAACC,IAAP,CAAYL,UAAU,CAACc,YAAvB,CADG,EAEN,GAAG,+BAAiBE,WAAjB,CAFG,CAAR,CADkB,EAKlBV,MALkB,CAKX,CAACuB,GAAD,EAAchC,cAAd,KAAiC;AACxC,UAAMiC,mBAAmB,GACvB9B,UAAU,CAACc,YAAX,CAAwBjB,cAAxB,KACAG,UAAU,CAACc,YAAX,CAAwBjB,cAAxB,EAAwCD,IAF1C;AAGA,QAAIA,IAAJ;AACA,QAAIG,MAAJ;;AACA,QAAI;AACFH,MAAAA,IAAI,GACFkC,mBAAmB,IACnB,mCAAqBd,WAArB,EAAkCnB,cAAlC,CAFF;AAGAE,MAAAA,MAAM,GAAG,sDAA6BH,IAA7B,CAAT;AACD,KALD,CAKE,OAAOmC,KAAP,EAAc;AACdC,yBAAOC,IAAP,CACE,8BAAc;oBACFC,iBAAMC,IAAN,CACRtC,cADQ,CAER;;oBAEQqC,iBAAME,GAAN,CAAUL,KAAK,CAACM,OAAhB,CAAyB,EALrC,CADF;;AAQA,aAAOR,GAAP;AACD;;AAED,UAAM5B,UAAU,GAAGG,MAAM,CAACC,IAAP,CAAYN,MAAM,CAACI,SAAnB,EAA8BmC,MAA9B,GAAuC,CAA1D;AAEA,WAAO,qBAAO,EAAP,EAAWT,GAAX,EAAgB;AACrBf,MAAAA,YAAY,EAAE,qBAAO,EAAP,EAAWe,GAAG,CAACf,YAAf,EAA6B;AACzC,aAAKjB,cAAL,IAAmC;AACjC,iBAAOF,mBAAmB,CACxBC,IADwB,EAExBC,cAFwB,EAGxBC,WAHwB,EAIxBC,MAJwB,EAKxBC,UALwB,EAMxBC,UANwB,CAA1B;AAQD;;AAVwC,OAA7B,CADO;AAarBqB,MAAAA,QAAQ,EAAE,CAAC,GAAGO,GAAG,CAACP,QAAR,EAAkB,GAAGvB,MAAM,CAACuB,QAA5B,CAbW;AAcrBnB,MAAAA,SAAS,EAAE,EACT,GAAG0B,GAAG,CAAC1B,SADE;AAET,WAAGJ,MAAM,CAACI;AAFD,OAdU;AAkBrBoB,MAAAA,YAAY,EAAE,CAAC,GAAGM,GAAG,CAACN,YAAR,EAAsB,GAAGxB,MAAM,CAACwB,YAAhC;AAlBO,KAAhB,CAAP;AAoBD,GAlDmB,EAkDjBL,aAlDiB,CAApB;AAoDA,SAAOpB,WAAP;AACD;;eAEciB,U","sourcesContent":["import path from 'path';\nimport chalk from 'chalk';\nimport {\n  UserDependencyConfig,\n  ProjectConfig,\n  Dependency,\n  UserConfig,\n  Config,\n} from '@react-native-community/cli-types';\nimport {logger, inlineString} from '@react-native-community/cli-tools';\nimport findDependencies from './findDependencies';\nimport findProjectRoot from './findProjectRoot';\nimport resolveReactNativePath from './resolveReactNativePath';\nimport findAssets from './findAssets';\nimport {\n  readConfigFromDisk,\n  readDependencyConfigFromDisk,\n} from './readConfigFromDisk';\nimport assign from '../assign';\nimport merge from '../merge';\nimport resolveNodeModuleDir from './resolveNodeModuleDir';\n\nfunction getDependencyConfig(\n  root: string,\n  dependencyName: string,\n  finalConfig: Config,\n  config: UserDependencyConfig,\n  userConfig: UserConfig,\n  isPlatform: boolean,\n): Dependency {\n  return merge(\n    {\n      root,\n      name: dependencyName,\n      platforms: Object.keys(finalConfig.platforms).reduce(\n        (dependency, platform) => {\n          const platformConfig = finalConfig.platforms[platform];\n          dependency[platform] =\n            // Linking platforms is not supported\n            isPlatform || !platformConfig\n              ? null\n              : platformConfig.dependencyConfig(\n                  root,\n                  config.dependency.platforms[platform],\n                );\n          return dependency;\n        },\n        {} as Config['platforms'],\n      ),\n      assets: findAssets(root, config.dependency.assets),\n      hooks: config.dependency.hooks,\n      params: config.dependency.params,\n    },\n    userConfig.dependencies[dependencyName] || {},\n  ) as Dependency;\n}\n\n/**\n * Loads CLI configuration\n */\nfunction loadConfig(projectRoot: string = findProjectRoot()): Config {\n  let lazyProject: ProjectConfig;\n  const userConfig = readConfigFromDisk(projectRoot);\n\n  const initialConfig: Config = {\n    root: projectRoot,\n    get reactNativePath() {\n      return userConfig.reactNativePath\n        ? path.resolve(projectRoot, userConfig.reactNativePath)\n        : resolveReactNativePath(projectRoot);\n    },\n    dependencies: userConfig.dependencies,\n    commands: userConfig.commands,\n    get assets() {\n      return findAssets(projectRoot, userConfig.assets);\n    },\n    healthChecks: [],\n    platforms: userConfig.platforms,\n    get project() {\n      if (lazyProject) {\n        return lazyProject;\n      }\n\n      lazyProject = {};\n      for (const platform in finalConfig.platforms) {\n        const platformConfig = finalConfig.platforms[platform];\n        if (platformConfig) {\n          lazyProject[platform] = platformConfig.projectConfig(\n            projectRoot,\n            userConfig.project[platform] || {},\n          );\n        }\n      }\n\n      return lazyProject;\n    },\n  };\n\n  const finalConfig = Array.from(\n    new Set([\n      ...Object.keys(userConfig.dependencies),\n      ...findDependencies(projectRoot),\n    ]),\n  ).reduce((acc: Config, dependencyName) => {\n    const localDependencyRoot =\n      userConfig.dependencies[dependencyName] &&\n      userConfig.dependencies[dependencyName].root;\n    let root: string;\n    let config: UserDependencyConfig;\n    try {\n      root =\n        localDependencyRoot ||\n        resolveNodeModuleDir(projectRoot, dependencyName);\n      config = readDependencyConfigFromDisk(root);\n    } catch (error) {\n      logger.warn(\n        inlineString(`\n          Package ${chalk.bold(\n            dependencyName,\n          )} has been ignored because it contains invalid configuration.\n\n          Reason: ${chalk.dim(error.message)}`),\n      );\n      return acc;\n    }\n\n    const isPlatform = Object.keys(config.platforms).length > 0;\n\n    return assign({}, acc, {\n      dependencies: assign({}, acc.dependencies, {\n        get [dependencyName](): Dependency {\n          return getDependencyConfig(\n            root,\n            dependencyName,\n            finalConfig,\n            config,\n            userConfig,\n            isPlatform,\n          );\n        },\n      }),\n      commands: [...acc.commands, ...config.commands],\n      platforms: {\n        ...acc.platforms,\n        ...config.platforms,\n      },\n      healthChecks: [...acc.healthChecks, ...config.healthChecks],\n    }) as Config;\n  }, initialConfig);\n\n  return finalConfig;\n}\n\nexport default loadConfig;\n"]}