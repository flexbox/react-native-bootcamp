{"version":3,"sources":["../../../src/commands/init/init.ts"],"names":["DEFAULT_VERSION","doesDirectoryExist","dir","fs","existsSync","setProjectDirectory","directory","DirectoryAlreadyExistsError","mkdirp","sync","process","chdir","error","CLIError","cwd","getTemplateName","name","Object","keys","JSON","parse","readFileSync","path","join","dependencies","createFromTemplate","projectName","templateUri","npm","projectTitle","skipInstall","logger","debug","log","banner","projectDirectory","Loader","loader","text","templateSourceDir","mkdtempSync","os","tmpdir","start","succeed","templateName","templateConfig","templateDir","placeholderName","placeholderTitle","titlePlaceholder","postInitScript","installDependencies","root","e","fail","Error","removeSync","PackageManager","installAll","preferYarn","silent","platform","createProject","version","options","template","title","initialize","argv","directoryName","relative","projectFolder","message"],"mappings":"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","sourcesContent":["import os from 'os';\nimport path from 'path';\nimport fs from 'fs-extra';\nimport minimist from 'minimist';\nimport ora from 'ora';\nimport mkdirp from 'mkdirp';\nimport {validateProjectName} from './validate';\nimport DirectoryAlreadyExistsError from './errors/DirectoryAlreadyExistsError';\nimport printRunInstructions from './printRunInstructions';\nimport {CLIError, logger} from '@react-native-community/cli-tools';\nimport {\n  installTemplatePackage,\n  getTemplateConfig,\n  copyTemplate,\n  executePostInitScript,\n} from './template';\nimport {changePlaceholderInTemplate} from './editTemplate';\nimport * as PackageManager from '../../tools/packageManager';\nimport installPods from '../../tools/installPods';\nimport banner from './banner';\nimport {getLoader} from '../../tools/loader';\n\nconst DEFAULT_VERSION = 'latest';\n\ntype Options = {\n  template?: string;\n  npm?: boolean;\n  directory?: string;\n  displayName?: string;\n  title?: string;\n  skipInstall?: boolean;\n};\n\ninterface TemplateOptions {\n  projectName: string;\n  templateUri: string;\n  npm?: boolean;\n  directory: string;\n  projectTitle?: string;\n  skipInstall?: boolean;\n}\n\nfunction doesDirectoryExist(dir: string) {\n  return fs.existsSync(dir);\n}\n\nasync function setProjectDirectory(directory: string) {\n  if (doesDirectoryExist(directory)) {\n    throw new DirectoryAlreadyExistsError(directory);\n  }\n\n  try {\n    mkdirp.sync(directory);\n    process.chdir(directory);\n  } catch (error) {\n    throw new CLIError(\n      'Error occurred while trying to create project directory.',\n      error,\n    );\n  }\n\n  return process.cwd();\n}\n\nfunction getTemplateName(cwd: string) {\n  // We use package manager to infer the name of the template module for us.\n  // That's why we get it from temporary package.json, where the name is the\n  // first and only dependency (hence 0).\n  const name = Object.keys(\n    JSON.parse(fs.readFileSync(path.join(cwd, './package.json'), 'utf8'))\n      .dependencies,\n  )[0];\n  return name;\n}\n\nasync function createFromTemplate({\n  projectName,\n  templateUri,\n  npm,\n  directory,\n  projectTitle,\n  skipInstall,\n}: TemplateOptions) {\n  logger.debug('Initializing new project');\n  logger.log(banner);\n\n  const projectDirectory = await setProjectDirectory(directory);\n\n  const Loader = getLoader();\n  const loader = new Loader({text: 'Downloading template'});\n  const templateSourceDir = fs.mkdtempSync(\n    path.join(os.tmpdir(), 'rncli-init-template-'),\n  );\n\n  try {\n    loader.start();\n\n    await installTemplatePackage(templateUri, templateSourceDir, npm);\n\n    loader.succeed();\n    loader.start('Copying template');\n\n    const templateName = getTemplateName(templateSourceDir);\n    const templateConfig = getTemplateConfig(templateName, templateSourceDir);\n    await copyTemplate(\n      templateName,\n      templateConfig.templateDir,\n      templateSourceDir,\n    );\n\n    loader.succeed();\n    loader.start('Processing template');\n\n    changePlaceholderInTemplate({\n      projectName,\n      projectTitle,\n      placeholderName: templateConfig.placeholderName,\n      placeholderTitle: templateConfig.titlePlaceholder,\n    });\n\n    loader.succeed();\n    const {postInitScript} = templateConfig;\n    if (postInitScript) {\n      // Leaving trailing space because there may be stdout from the script\n      loader.start('Executing post init script ');\n      await executePostInitScript(\n        templateName,\n        postInitScript,\n        templateSourceDir,\n      );\n      loader.succeed();\n    }\n\n    if (!skipInstall) {\n      await installDependencies({\n        projectName,\n        npm,\n        loader,\n        root: projectDirectory,\n      });\n    } else {\n      loader.succeed('Dependencies installation skipped');\n    }\n  } catch (e) {\n    loader.fail();\n    throw new Error(e);\n  } finally {\n    fs.removeSync(templateSourceDir);\n  }\n}\n\nasync function installDependencies({\n  projectName,\n  npm,\n  loader,\n  root,\n}: {\n  projectName: string;\n  npm?: boolean;\n  loader: ora.Ora;\n  root: string;\n}) {\n  loader.start('Installing dependencies');\n\n  await PackageManager.installAll({\n    preferYarn: !npm,\n    silent: true,\n    root,\n  });\n\n  if (process.platform === 'darwin') {\n    await installPods({projectName, loader});\n  }\n\n  loader.succeed();\n}\n\nasync function createProject(\n  projectName: string,\n  directory: string,\n  version: string,\n  options: Options,\n) {\n  const templateUri = options.template || `react-native@${version}`;\n\n  return createFromTemplate({\n    projectName,\n    templateUri,\n    npm: options.npm,\n    directory,\n    projectTitle: options.title,\n    skipInstall: options.skipInstall,\n  });\n}\n\nexport default (async function initialize(\n  [projectName]: Array<string>,\n  options: Options,\n) {\n  const root = process.cwd();\n\n  validateProjectName(projectName);\n\n  /**\n   * Commander is stripping `version` from options automatically.\n   * We have to use `minimist` to take that directly from `process.argv`\n   */\n  const version: string = minimist(process.argv).version || DEFAULT_VERSION;\n\n  const directoryName = path.relative(root, options.directory || projectName);\n\n  try {\n    await createProject(projectName, directoryName, version, options);\n\n    const projectFolder = path.join(root, directoryName);\n    printRunInstructions(projectFolder, projectName);\n  } catch (e) {\n    logger.error(e.message);\n  }\n});\n"]}